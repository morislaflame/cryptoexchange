# Гостевой чат - Документация

## Обзор

Система теперь поддерживает гостевой чат для неавторизованных пользователей. Гости могут создавать чаты поддержки и общаться с администраторами без необходимости регистрации.

## Архитектура

### Backend изменения

1. **Новые роуты в `chatRouter.js`:**
   - `POST /api/chat/guest/support` - создание гостевого чата поддержки
   - `GET /api/chat/guest/:id` - получение гостевого чата по ID

2. **Новые методы в `chatController.js`:**
   - `createGuestSupportChat()` - создание гостевого чата поддержки
   - `getGuestChatById()` - получение гостевого чата

3. **Обновления в `chatSocketService.js`:**
   - Поддержка гостевых сообщений в `send_message`
   - Поддержка гостевого подключения в `join_chat`
   - Обновленные обработчики для работы без аутентификации

4. **Обновления в `models.js`:**
   - Добавлен тип `GUEST` в `senderType` для сообщений
   - Связь `Message.belongsTo(User)` теперь опциональная

### Frontend изменения

1. **Новые API методы в `chatAPI.ts`:**
   - `createGuestSupportChat()` - создание гостевого чата
   - `getGuestChatById()` - получение гостевого чата

2. **Обновления в `ChatStore.ts`:**
   - Добавлен флаг `_isGuest` для отслеживания гостевого режима
   - Новые методы `createGuestSupportChat()` и `fetchGuestChat()`
   - Логика проверки localStorage для восстановления гостевого чата
   - Методы `clearChat()` и `clearGuestChat()` для управления состоянием

3. **Новый компонент `GuestChatModal.tsx`:**
   - Модальное окно для гостевого чата
   - Работает без аутентификации
   - Поддерживает WebSocket соединения

4. **Обновления в `MainPage.tsx`:**
   - Централизованное управление WebSocket подключениями
   - Индикатор непрочитанных сообщений над кнопкой чата
   - Обработка отправки сообщений через глобальный сокет
   - Условное отображение чата в зависимости от статуса авторизации
   - Авторизованные пользователи видят `ChatModal`
   - Неавторизованные пользователи видят `GuestChatModal`
   - Визуальный индикатор "Гость" для неавторизованных пользователей

5. **Обновления в `ChatMessage.tsx`:**
   - Улучшенная логика определения "своих" сообщений
   - Для авторизованных пользователей: проверка по userId
   - Для гостей: гостевые сообщения (senderType === 'GUEST') считаются своими
   - Отображение имени отправителя для чужих сообщений

## Использование

### Для неавторизованных пользователей

1. Пользователь нажимает на кнопку чата на главной странице
2. Открывается `GuestChatModal`
3. Система проверяет localStorage на наличие сохраненного ID чата
4. Если чат найден - подключается к существующему, иначе создается новый
5. Пользователь может отправлять сообщения администраторам
6. Администраторы получают уведомления в Telegram
7. При закрытии чата ID сохраняется в localStorage для продолжения общения

### Для авторизованных пользователей

1. Работает как раньше через `ChatModal`
2. Полная функциональность чата с сохранением истории
3. Уведомления о непрочитанных сообщениях

## Особенности гостевого чата

1. **Без аутентификации:** Гости могут использовать чат без регистрации
2. **Сохранение чата:** ID гостевого чата сохраняется в localStorage для продолжения общения
3. **WebSocket поддержка:** Реальное время общения с администраторами
4. **Уведомления:** Администраторы получают уведомления о новых сообщениях гостей
5. **Индикатор непрочитанных сообщений:** Красная точка на кнопке чата при новых сообщениях
6. **Централизованное управление:** Все WebSocket подключения управляются на уровне MainPage
7. **Умное отображение сообщений:** 
   - Гостевые сообщения отображаются как "свои" для неавторизованных пользователей
   - Авторизованные пользователи видят гостевые сообщения как "чужие" с подписью "Гость"
   - Сообщения от администраторов помечаются соответствующим образом

## Безопасность

1. Гостевые чаты ограничены только типом `SUPPORT`
2. Гости не могут получить доступ к чатам других пользователей
3. Все гостевые сообщения помечаются типом `GUEST`
4. Администраторы видят, что сообщение от гостя

## Миграция базы данных

Для поддержки гостевых сообщений необходимо обновить enum в базе данных:

```sql
ALTER TABLE messages MODIFY COLUMN senderType ENUM('USER', 'ADMIN', 'SYSTEM', 'GUEST') DEFAULT 'USER';
```

## Тестирование

1. Откройте приложение в режиме инкогнито (неавторизованный пользователь)
2. Нажмите на кнопку чата
3. Убедитесь, что открывается гостевой чат
4. Отправьте сообщение
5. Проверьте, что администратор получает уведомление
